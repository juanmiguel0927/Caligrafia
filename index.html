<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Entrenador De Caligraf√≠a </title>
    
    <!-- FUENTES -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* --- VARIABLES --- */
        :root {
            --row-h: 60px;
            --font-s: 40px;
            --stroke-w: 1.5px;
        }

        body { background-color: #111827; color: #e5e7eb; }

        /* MODAL PDF */
        #pdfLoadingModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 100000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #8b5cf6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* HOJA CARTA */
        .sheet {
            width: 8.5in; min-height: 11in; background-color: white; position: relative;
            padding: 0.5in 0.7in; box-sizing: border-box; margin: 0 auto; color: black;
        }

        /* --- FONDOS DE PAPEL (SOLO CUADR√çCULA Y BLANCO) --- */
        .bg-grid {
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 20px 20px !important; 
            background-position: 0 10px; /* Alineaci√≥n base */
        }
        .bg-blank { background: none; border-bottom: 1px dashed #f9fafb; }

        /* MODO FOTOCOPIA */
        .grayscale-mode .dynamic-row { border-color: black !important; }
        .grayscale-mode.bg-grid {
             background-image: linear-gradient(#000 1px, transparent 1px), linear-gradient(90deg, #000 1px, transparent 1px);
        }

        /* --- RENGLONES --- */
        .dynamic-row {
            width: 100%;
            height: var(--row-h); 
            position: relative;
            display: flex;
            align-items: flex-end; 
            padding-bottom: 8px; /* Ajuste fino para sentar en l√≠nea de cuadr√≠cula */
            box-sizing: border-box;
        }

        /* TEXTO */
        .row-text {
            font-size: var(--font-s);
            line-height: 1; 
            width: 100%;
            white-space: pre-wrap; 
            word-break: break-word;
            z-index: 10;
            transform: translateY(2px); 
        }
        .font-cursive { font-family: 'Dancing Script', cursive; }
        .font-print { font-family: 'Lexend', sans-serif; letter-spacing: 2px; }

        /* SVG */
        .row-svg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; overflow: hidden; pointer-events: none;
            padding-bottom: 8px; 
            box-sizing: border-box;
        }
        .row-svg svg { height: 100%; width: auto; }

        /* UI */
        .btn-exercise { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; padding: 4px; height: 50px; transition: all 0.2s; border-radius: 6px; }
        .btn-preview { width: 100%; height: 25px; display: flex; justify-content: center; align-items: center; background-color: #e5e7eb; margin-bottom: 2px; overflow: hidden; }
        .btn-preview svg { height: 100%; width: auto; stroke: #374151; }
        details > summary { list-style: none; cursor: pointer; }

        @media (max-width: 768px) {
            .sheet { min-width: 8.5in; }
            #previewContainer { height: calc(100vh - 80px); background: #111827; padding: 10px; display: block; overflow: auto; -webkit-overflow-scrolling: touch; }
            #panelConfig { background-color: #111827; } 
        }
        @media (min-width: 769px) {
            #mobileTabs { display: none; }
            #panelConfig { display: flex !important; }
            #panelPreview { display: flex !important; }
        }
        @media print {
            .no-print { display: none !important; }
            body * { visibility: hidden; }
            #sheet, #sheet * { visibility: visible; }
            #sheet { position: fixed; left: 0; top: 0; width: 8.5in !important; height: 11in !important; margin: 0 !important; padding: 0.5in 0.7in !important; overflow: hidden !important; z-index: 99999; background: white !important; color: black !important; }
        }
    </style>
</head>
<body class="bg-gray-900 h-screen overflow-hidden flex flex-col md:flex-row font-sans text-gray-100">

    <!-- MODAL -->
    <div id="pdfLoadingModal">
        <div class="loader"></div>
        <h2 class="text-white font-bold text-lg">Generando PDF...</h2>
    </div>

    <!-- PANEL LATERAL -->
    <aside id="panelConfig" class="w-full md:w-[450px] bg-gray-900 text-gray-100 shadow-xl z-20 flex flex-col h-full md:h-screen overflow-y-auto border-r border-gray-700 hidden md:flex relative">
        <div class="p-4 space-y-4 pb-24 md:pb-5">
            <div class="border-b border-gray-700 pb-2 flex justify-between items-center">
                <h2 class="text-xl font-bold text-blue-400">‚úçÔ∏è Caligraf√≠a Pro</h2>
                <div class="flex gap-2">
                    <button onclick="resetAll()" class="text-xs bg-red-900/50 hover:bg-red-800 text-red-200 px-3 py-1 rounded border border-red-800">Borrar Todo</button>
                </div>
            </div>

            <!-- SECCI√ìN MUSICAL -->
            <div class="bg-indigo-900/30 p-3 rounded-lg border border-indigo-800 shadow-inner">
                <label class="text-[10px] text-indigo-300 uppercase font-bold block mb-2">üéµ Repertorio Musical (30 Obras)</label>
                <div class="flex gap-2 mb-3">
                    <select id="songSelect" class="w-full bg-gray-900 border border-gray-600 text-gray-200 rounded p-1 text-xs focus:ring-2 focus:ring-indigo-500">
                        <option value="">-- Selecciona Obra --</option>
                        <optgroup label="1. Rectos y Marcados">
                            <option value="radetzky">1. Marcha Radetzky</option>
                            <option value="marcha_turca">2. Marcha Turca</option>
                            <option value="guillermo_tell">3. Guillermo Tell</option>
                            <option value="toreros">4. Marcha Toreros</option>
                            <option value="sable">5. Danza del Sable</option>
                            <option value="montescos">6. Montescos y Capuletos</option>
                        </optgroup>
                        <optgroup label="2. Curvas y Ondas">
                            <option value="danubio">7. El Danubio Azul</option>
                            <option value="cisne">8. El Cisne</option>
                            <option value="acuario">9. Acuario</option>
                            <option value="clair_lune">10. Claro de Luna (Debussy)</option>
                            <option value="nocturne">11. Nocturno (Chopin)</option>
                            <option value="ave_maria">12. Ave Maria (Schubert)</option>
                        </optgroup>
                        <optgroup label="3. Bucles y Espirales">
                            <option value="moscardon">13. Vuelo del Moscard√≥n</option>
                            <option value="flores">14. Vals de las Flores</option>
                            <option value="primavera">15. La Primavera</option>
                            <option value="eine_kleine">16. Peque√±a Serenata (Mozart)</option>
                            <option value="sinfonia40">17. Sinfon√≠a 40 (Mozart)</option>
                        </optgroup>
                        <optgroup label="4. Puntos y Staccato">
                            <option value="pizzicato">18. Pizzicato Polka</option>
                            <option value="maquina">19. M√°quina de Escribir</option>
                            <option value="annen">20. Annen Polka</option>
                            <option value="hada">21. Hada de Az√∫car</option>
                            <option value="popcorn">22. Popcorn</option>
                        </optgroup>
                        <optgroup label="5. Mixtos">
                            <option value="rey_montana">23. Rey de la Monta√±a</option>
                            <option value="pantera">24. Pantera Rosa</option>
                            <option value="humoresque">25. Humoresque (Dvorak)</option>
                            <option value="brujo">26. Aprendiz de Brujo</option>
                            <option value="1812">27. Obertura 1812</option>
                            <option value="hungara">28. Danza H√∫ngara 5</option>
                            <option value="cancan">29. Can Can</option>
                            <option value="gladiadores">30. Gladiadores</option>
                        </optgroup>
                    </select>
                    <button onclick="loadSong()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 rounded text-xs font-bold transition">Cargar</button>
                </div>
                
                <div id="youtubeContainer" class="hidden rounded overflow-hidden border border-gray-700 mt-2 bg-black"></div>
                <div class="flex items-center gap-2 mt-2">
                     <div class="flex items-center gap-1 bg-gray-800 rounded p-1 border border-gray-600 w-full justify-center">
                        <button id="metroBtn" onclick="toggleMetronome()" class="text-xs px-3 py-1 bg-gray-600 rounded hover:bg-gray-500">‚ñ∂ Metr√≥nomo</button>
                        <input type="number" id="bpmInput" value="60" class="w-10 text-xs bg-transparent text-center outline-none text-white font-mono">
                        <span class="text-[9px] text-gray-400">BPM</span>
                    </div>
                </div>
            </div>

            <!-- CONTADOR -->
            <div class="bg-gray-800 p-2 rounded border border-gray-600 flex justify-between items-center">
                <span class="text-xs font-bold text-gray-300 uppercase">Capacidad Hoja:</span>
                <span id="lineCounter" class="text-xs font-mono font-bold text-green-400">0 / --</span>
            </div>

            <!-- GENERADORES -->
            <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
                <label class="text-[10px] text-gray-400 uppercase font-bold block mb-2">Generadores R√°pidos</label>
                <div class="grid grid-cols-6 gap-2">
                    <button onclick="fillPage('rectos')" class="p-2 bg-blue-900/30 hover:bg-blue-800 border border-blue-800 rounded flex flex-col items-center" title="Rectos"><span class="text-lg">üìè</span></button>
                    <button onclick="fillPage('curvas')" class="p-2 bg-green-900/30 hover:bg-green-800 border border-green-800 rounded flex flex-col items-center" title="Curvas"><span class="text-lg">d o</span></button>
                    <button onclick="fillPage('bucles')" class="p-2 bg-orange-900/30 hover:bg-orange-800 border border-orange-800 rounded flex flex-col items-center" title="Bucles"><span class="text-lg">‚û∞</span></button>
                    <button onclick="fillPage('mix')" class="p-2 bg-purple-900/30 hover:bg-purple-800 border border-purple-800 rounded flex flex-col items-center" title="Mix"><span class="text-lg">üîÄ</span></button>
                    <button onclick="fillPage('texto')" class="p-2 bg-gray-700 hover:bg-gray-600 border border-gray-600 rounded flex flex-col items-center" title="Texto"><span class="text-lg">üìù</span></button>
                    
                    <!-- NUEVO BOT√ìN ALEATORIO -->
                    <button onclick="fillPage('random')" class="p-2 bg-red-900/30 hover:bg-red-800 border border-red-800 rounded flex flex-col items-center" title="Aleatorio Total">
                        <span class="text-lg">üé≤</span>
                    </button>
                </div>
                
                <label class="text-[10px] text-gray-400 uppercase font-bold block mb-2 mt-3 pt-3 border-t border-gray-600">Letras</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="fillPage('abecedario')" class="p-2 bg-indigo-900/30 hover:bg-indigo-800 border border-indigo-800 rounded flex flex-col items-center"><span class="text-lg">üî§</span></button>
                    <button onclick="fillPage('vocales')" class="p-2 bg-pink-900/30 hover:bg-pink-800 border border-pink-800 rounded flex flex-col items-center"><span class="text-lg">üó£Ô∏è</span></button>
                    <button onclick="fillPage('pangramas')" class="p-2 bg-teal-900/30 hover:bg-teal-800 border border-teal-800 rounded flex flex-col items-center"><span class="text-lg">üìú</span></button>
                </div>
            </div>

            <!-- CONTROLES MANUALES -->
            <div id="manualControls" class="space-y-1"></div>

            <!-- INPUT -->
            <textarea id="inputText" rows="2" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-mono text-gray-200" placeholder="Escribe aqu√≠..."></textarea>

            <!-- AJUSTES -->
            <div class="bg-gray-800 p-3 rounded-lg border border-gray-700 space-y-3">
                <div class="flex justify-between items-center text-[10px] border-b border-gray-700 pb-2">
                    <label class="flex items-center text-gray-400 font-bold"><input type="checkbox" id="toggleHeader" checked onchange="render()" class="accent-blue-500 mr-1"> Encabezado</label>
                    <label class="flex items-center text-gray-400 font-bold"><input type="checkbox" id="toggleGrayscale" onchange="render()" class="accent-gray-500 mr-1"> B&N</label>
                </div>

                <div class="grid grid-cols-3 gap-1 text-[10px]">
                    <label class="flex items-center cursor-pointer"><input type="radio" name="practiceMode" value="simple" checked onchange="render()" class="accent-blue-500 mr-1"> Simple</label>
                    <label class="flex items-center cursor-pointer"><input type="radio" name="practiceMode" value="plana" onchange="render()" class="accent-blue-500 mr-1"> Alterno</label>
                    <label class="flex items-center cursor-pointer"><input type="radio" name="practiceMode" value="progressive" onchange="render()" class="accent-blue-500 mr-1"> Progresivo</label>
                </div>
                
                <div id="headerInputs" class="flex gap-2">
                    <input type="text" id="schoolName" placeholder="Colegio" class="w-1/2 bg-gray-900 border border-gray-600 text-gray-300 text-[10px] rounded p-1">
                    <input type="text" id="studentName" placeholder="Alumno/T√≠tulo" class="w-1/2 bg-gray-900 border border-gray-600 text-gray-300 text-[10px] rounded p-1">
                </div>

                <div class="flex gap-2 justify-center pt-2 border-t border-gray-700">
                    <button onclick="setColor('black')" class="w-5 h-5 rounded-full bg-black border border-gray-500 ring-1 ring-white/20"></button>
                    <button onclick="setColor('#2563eb')" class="w-5 h-5 rounded-full bg-blue-600 border border-gray-500 ring-1 ring-white/20"></button>
                    <button onclick="setColor('#dc2626')" class="w-5 h-5 rounded-full bg-red-600 border border-gray-500 ring-1 ring-white/20"></button>
                    <button onclick="setColor('rainbow')" class="w-5 h-5 rounded-full bg-gradient-to-r from-blue-500 to-red-500 border border-gray-500 ring-1 ring-white/20" title="Alternar"></button>
                </div>

                <div class="grid grid-cols-2 gap-2 border-t border-gray-700 pt-2">
                    <div>
                        <div class="flex justify-between mb-1"><label class="text-[10px] uppercase font-bold text-gray-400">Tama√±o</label><span id="sizeVal" class="text-[9px] font-mono text-blue-300">40px</span></div>
                        <input type="range" id="sizeRange" min="20" max="100" value="40" class="w-full h-1 bg-gray-600 rounded accent-blue-400">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1"><label class="text-[10px] uppercase font-bold text-gray-400">Grosor</label><span id="weightVal" class="text-[9px] font-mono text-blue-300">1.5px</span></div>
                        <input type="range" id="weightRange" min="1" max="5" step="0.5" value="1.5" class="w-full h-1 bg-gray-600 rounded accent-blue-400">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1"><label class="text-[10px] uppercase font-bold text-gray-400">Opacidad</label><span id="opacityVal" class="text-[9px] font-mono text-blue-300">30%</span></div>
                        <input type="range" id="opacityRange" min="10" max="100" value="30" class="w-full h-1 bg-gray-600 rounded accent-blue-400">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                     <div>
                        <label class="text-[10px] text-gray-400 uppercase font-bold mb-1 block">Papel</label>
                        <select id="paperSelect" class="w-full bg-gray-900 border border-gray-600 text-gray-300 rounded p-1 text-[10px]">
                            <option value="bg-grid">Cuadr√≠cula</option>
                            <option value="bg-blank">Blanco</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 uppercase font-bold mb-1 block">Fuente</label>
                        <select id="fontSelect" class="w-full bg-gray-900 border border-gray-600 text-gray-300 rounded p-1 text-[10px]">
                            <option value="font-cursive">Cursiva</option>
                            <option value="font-print">Imprenta</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="text-center pt-2 border-t border-gray-700 mt-2">
                <p class="text-[10px] text-gray-500">Desarrollado por <strong class="text-gray-400">Juan Miguel Rios Redondo</strong></p>
            </div>
        </div>
    </aside>

    <!-- PREVIEW AREA -->
    <main id="panelPreview" class="flex-1 bg-gray-800 h-full overflow-hidden flex flex-col relative hidden md:flex">
        <div class="md:hidden bg-gray-900 text-white p-2 text-center text-xs font-bold uppercase shadow z-10 flex justify-between items-center px-4 no-print">
            <span>Vista Previa</span>
            <button onclick="downloadPDF()" class="text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded font-bold">PDF</button>
        </div>

        <div id="previewContainer" class="flex-1 w-full flex justify-center p-0 md:p-8 overflow-auto">
            <div id="sheet" class="sheet bg-grid shadow-2xl origin-top">
                <div class="flex-grow flex flex-col h-full w-full">
                    <div id="headerContainer" class="flex flex-col items-center border-b-2 border-gray-800 pb-2 mb-0 h-[25mm] justify-end flex-shrink-0 w-full">
                        <h1 id="headerTitleDisplay" class="text-xl font-bold text-gray-800 uppercase tracking-wide font-sans w-full text-center">Caligraf√≠a</h1>
                        <div class="w-full flex justify-between text-sm text-gray-500 mt-1 font-mono">
                            <span id="studentNameDisplay">_________________</span>
                            <span>Fecha: _______</span>
                        </div>
                    </div>
                    <div id="linesContainer" class="w-full relative flex-grow flex flex-col"></div>
                </div>
                <div class="mt-auto pt-1 border-t border-gray-300 text-center flex-shrink-0 w-full">
                    <p class="text-[8px] text-gray-400 font-sans">Material educativo creado con el Entrenador de Caligraf√≠a de Juan Miguel Rios Redondo</p>
                </div>
            </div>
        </div>
        <button onclick="downloadPDF()" class="absolute bottom-10 right-10 bg-red-600 hover:bg-red-500 text-white p-4 rounded-full shadow-xl z-50 transition transform hover:scale-110 hidden md:flex flex-col items-center justify-center h-16 w-16 no-print">
            <span class="text-xs font-bold">PDF</span>
            <span class="text-lg">‚¨áÔ∏è</span>
        </button>
    </main>

    <!-- TABS M√ìVIL -->
    <nav id="mobileTabs" class="fixed bottom-0 w-full bg-gray-900 border-t border-gray-800 flex justify-around py-2 z-50 shadow-lg md:hidden h-16 no-print">
        <button onclick="switchTab('config')" id="tabConfig" class="flex flex-col items-center justify-center text-blue-400 w-1/2"><span class="text-xl mb-1">üõ†Ô∏è</span><span class="text-[10px] font-bold">EDITOR</span></button>
        <button onclick="switchTab('preview')" id="tabPreview" class="flex flex-col items-center justify-center text-gray-400 w-1/2"><span class="text-xl mb-1">üìÑ</span><span class="text-[10px] font-bold">HOJA</span></button>
    </nav>

    <script>
        const svgPaths = {
            '{{VERT}}': '<line x1="7.5" y1="15" x2="7.5" y2="45" />', '{{INCL}}': '<line x1="12" y1="15" x2="3" y2="45" />',
            '{{GUION}}': '<line x1="2" y1="30" x2="23" y2="30" />', '{{ALMENA}}': '<path d="M0,45 L0,20 L15,20 L15,45 L30,45" fill="none" />',
            '{{ZIGZAG}}': '<path d="M0,45 L10,15 L20,45" fill="none" />', '{{L_SHAPE}}': '<path d="M5,15 L5,40 Q5,45 15,45" fill="none" />',
            '{{U_SHAPE}}': '<path d="M2,20 Q10,55 18,20" fill="none" />', '{{ARCH}}': '<path d="M2,45 Q10,10 18,45" fill="none" />',
            '{{C_SHAPE}}': '<path d="M18,20 Q2,32.5 18,45" fill="none" />', '{{C_REV}}': '<path d="M2,20 Q18,32.5 2,45" fill="none" />',
            '{{CIRCLE}}': '<circle cx="12.5" cy="32.5" r="8" fill="none" />', '{{J_HOOK}}': '<path d="M15,20 L15,45 Q15,55 5,50" fill="none" />',
            '{{BUCLE_E}}': '<path d="M0,45 Q5,45 5,35 Q5,25 10,25 Q15,25 15,35 Q15,45 20,45" fill="none" />',
            '{{BUCLE_L}}': '<path d="M0,45 Q10,45 10,10 Q10,10 20,45" fill="none" />',
            '{{OLAS}}': '<path d="M0,35 Q7.5,20 15,35 T30,35" fill="none" />', '{{MUELLE}}': '<path d="M0,40 Q7.5,10 15,40" fill="none" />',
            '{{ESPIRAL}}': '<path d="M5,40 C5,25 35,25 35,40 C35,50 15,50 15,35 C15,30 25,30 25,35" fill="none" />',
            '{{ROMBOS}}': '<path d="M0,32.5 L15,15 L30,32.5 L15,50 L0,32.5" fill="none" />'
        };

        const buttonConfig = {
            'btnGroupRectos': ['{{VERT}}', '{{INCL}}', '{{GUION}}', '{{ALMENA}}', '{{ZIGZAG}}', '{{L_SHAPE}}'],
            'btnGroupCurvas': ['{{U_SHAPE}}', '{{ARCH}}', '{{C_SHAPE}}', '{{C_REV}}', '{{CIRCLE}}', '{{J_HOOK}}'],
            'btnGroupBucles': ['{{BUCLE_E}}', '{{BUCLE_L}}', '{{OLAS}}', '{{MUELLE}}', '{{ESPIRAL}}', '{{ROMBOS}}']
        };

        const categories = {
            rectos: buttonConfig.btnGroupRectos,
            curvas: buttonConfig.btnGroupCurvas,
            bucles: buttonConfig.btnGroupBucles,
            mix: Object.keys(svgPaths),
            texto: ["Aa Bb Cc Dd Ee", "Ff Gg Hh Ii Jj", "Kk Ll Mm Nn √ë√±", "Oo Pp Qq Rr Ss", "Tt Uu Vv Ww Xx", "Yy Zz 0 1 2 3 4"],
            abecedario: ["Aa Bb Cc Dd Ee Ff Gg Hh", "Ii Jj Kk Ll Mm Nn √ë√± Oo", "Pp Qq Rr Ss Tt Uu Vv Ww", "Xx Yy Zz 0 1 2 3 4 5 6 7 8 9"],
            vocales: ["Aa Ee Ii Oo Uu", "a e i o u a e i o u", "A E I O U A E I O U", "AEIOU AEIOU"],
            pangramas: ["El veloz murci√©lago hind√∫ com√≠a feliz cardillo y kiwi.", "La cig√ºe√±a tocaba el saxof√≥n detr√°s del palenque de paja.", "Jovencillo emponzo√±ado de whisky: ¬°qu√© figurota exhibe!", "Benjam√≠n pidi√≥ una bebida de kiwi y fresa; No√©, sin verg√ºenza."]
        };

        const musicRep = {
            'marcha_turca': { id: "7bCl6MnQ8bw", name: "Marcha Turca (Mozart)", patterns: ['{{ZIGZAG}}', '{{VERT}}', '{{ALMENA}}', '{{ZIGZAG}}'] },
            'radetzky': { id: "XzP2ThLUSCk", name: "Marcha Radetzky", patterns: ['{{VERT}}', '{{GUION}}', '{{L_SHAPE}}', '{{VERT}}'] },
            'toreros': { id: "4DNGMoMNLRY", name: "Marcha Toreros", patterns: ['{{ALMENA}}', '{{L_SHAPE}}', '{{VERT}}', '{{ALMENA}}'] },
            'guillermo_tell': { id: "YIbYCOiETx0", name: "Guillermo Tell", patterns: ['{{INCL}}', '{{GUION}}', '{{INCL}}', '{{VERT}}'] },
            'sable': { id: "gqg3l3r_DRI", name: "Danza del Sable", patterns: ['{{ZIGZAG}}', '{{INCL}}', '{{ZIGZAG}}', '{{VERT}}'] },
            'montescos': { id: "Z_hOR50u7ek", name: "Montescos y Capuletos", patterns: ['{{GUION}}', '{{L_SHAPE}}', '{{VERT}}', '{{GUION}}'] },
            'danubio': { id: "dJCwYESbFOw", name: "El Danubio Azul", patterns: ['{{OLAS}}', '{{ARCH}}', '{{U_SHAPE}}', '{{OLAS}}'] },
            'cisne': { id: "3qrKjywjo7Q", name: "El Cisne", patterns: ['{{U_SHAPE}}', '{{OLAS}}', '{{ARCH}}', '{{U_SHAPE}}'] },
            'acuario': { id: "AsD0FDLOKGA", name: "Acuario", patterns: ['{{ESPIRAL}}', '{{CIRCLE}}', '{{U_SHAPE}}', '{{ESPIRAL}}'] },
            'clair_lune': { id: "ea2WoUtbzuw", name: "Claro de Luna", patterns: ['{{OLAS}}', '{{ARCH}}', '{{C_SHAPE}}', '{{OLAS}}'] },
            'nocturne': { id: "9E6b3swbnWg", name: "Nocturno", patterns: ['{{U_SHAPE}}', '{{C_REV}}', '{{OLAS}}', '{{U_SHAPE}}'] },
            'ave_maria': { id: "2bosouX_d8Y", name: "Ave Maria", patterns: ['{{ARCH}}', '{{OLAS}}', '{{ARCH}}', '{{OLAS}}'] },
            'moscardon': { id: "aYAJopwEYv8", name: "Vuelo del Moscard√≥n", patterns: ['{{BUCLE_E}}', '{{ESPIRAL}}', '{{BUCLE_E}}', '{{MUELLE}}'] },
            'flores': { id: "QxHk_3yzt3c", name: "Vals de las Flores", patterns: ['{{BUCLE_L}}', '{{OLAS}}', '{{BUCLE_L}}', '{{ARCH}}'] },
            'primavera': { id: "l-dYNttdgl0", name: "La Primavera", patterns: ['{{BUCLE_L}}', '{{ROMBOS}}', '{{U_SHAPE}}', '{{BUCLE_L}}'] },
            'eine_kleine': { id: "o1FSN8_pp_o", name: "Peque√±a Serenata", patterns: ['{{BUCLE_L}}', '{{ROMBOS}}', '{{ZIGZAG}}', '{{BUCLE_L}}'] },
            'sinfonia40': { id: "JTc1mDieQI8", name: "Sinfon√≠a 40", patterns: ['{{ESPIRAL}}', '{{BUCLE_E}}', '{{ESPIRAL}}', '{{ZIGZAG}}'] },
            'pizzicato': { id: "R_xrkenwf3I", name: "Pizzicato Polka", patterns: ['{{GUION}}', '{{CIRCLE}}', '{{GUION}}', '{{CIRCLE}}'] },
            'maquina': { id: "G4nX0Xrn-wo", name: "La M√°quina de Escribir", patterns: ['{{CIRCLE}}', '{{GUION}}', '{{CIRCLE}}', '{{GUION}}'] },
            'annen': { id: "45aW6Jv4C7U", name: "Annen Polka", patterns: ['{{GUION}}', '{{CIRCLE}}', '{{GUION}}', '{{CIRCLE}}'] },
            'hada': { id: "Wz_f9B4pPtg", name: "Hada de Az√∫car", patterns: ['{{CIRCLE}}', '{{U_SHAPE}}', '{{CIRCLE}}', '{{ARCH}}'] },
            'popcorn': { id: "NjxwkZ1s7BA", name: "Popcorn", patterns: ['{{CIRCLE}}', '{{ZIGZAG}}', '{{CIRCLE}}', '{{ZIGZAG}}'] },
            'rey_montana': { id: "kLp_Hh6DKWc", name: "Rey de la Monta√±a", patterns: ['{{CIRCLE}}', '{{GUION}}', '{{ZIGZAG}}', '{{ESPIRAL}}'] },
            'pantera': { id: "jBupII3LH_Q", name: "Pantera Rosa", patterns: ['{{GUION}}', '{{L_SHAPE}}', '{{GUION}}', '{{L_SHAPE}}'] },
            'humoresque': { id: "oSDQz-c8kXE", name: "Humoresque", patterns: ['{{ARCH}}', '{{GUION}}', '{{ARCH}}', '{{GUION}}'] },
            'brujo': { id: "U4yH4B9deok", name: "Aprendiz de Brujo", patterns: ['{{VERT}}', '{{ESPIRAL}}', '{{VERT}}', '{{ESPIRAL}}'] },
            '1812': { id: "VbxgYlcNxE8", name: "Obertura 1812", patterns: ['{{INCL}}', '{{ZIGZAG}}', '{{INCL}}', '{{ZIGZAG}}'] },
            'hungara': { id: "3X9LvC9WkkQ", name: "Danza H√∫ngara 5", patterns: ['{{OLAS}}', '{{ZIGZAG}}', '{{OLAS}}', '{{ZIGZAG}}'] },
            'cancan': { id: "4DNGMoMNLRY", name: "Can Can", patterns: ['{{VERT}}', '{{INCL}}', '{{VERT}}', '{{INCL}}'] },
            'gladiadores': { id: "_B0CyOAO8y0", name: "Entrada Gladiadores", patterns: ['{{ESPIRAL}}', '{{OLAS}}', '{{ESPIRAL}}', '{{OLAS}}'] }
        };

        let selectedColor = '#000000'; 
        let maxLinesDynamic = 13;
        let audioCtx = null;
        let metronomeInterval = null;
        let isMetronomeOn = false;

        // Generar botones manuales
        const manualContainer = document.getElementById('manualControls');
        const groups = [
            { id: 'rectos', title: 'Rectos', items: categories.rectos, color: 'text-blue-300' },
            { id: 'curvas', title: 'Curvas', items: categories.curvas, color: 'text-green-300' },
            { id: 'bucles', title: 'Bucles', items: categories.bucles, color: 'text-orange-300' }
        ];

        groups.forEach(g => {
            let html = `<details class="group bg-gray-800 rounded-lg border border-gray-700">
                <summary class="p-2 font-bold text-[10px] uppercase ${g.color} hover:bg-gray-700 flex justify-between select-none">${g.title}<span class="transform group-open:rotate-180">‚ñº</span></summary>
                <div class="p-2 grid grid-cols-4 gap-2 bg-gray-900/50">`;
            g.items.forEach(tag => {
                const svgIcon = `<svg viewBox="0 0 40 60" style="width:100%;height:100%;stroke:currentColor;stroke-width:2;fill:none;">${svgPaths[tag]}</svg>`;
                html += `<button onclick="addGraphic('${tag}')" class="btn-exercise bg-gray-800 border border-gray-600 hover:bg-gray-700">
                    <span class="btn-preview bg-gray-300 text-black">${svgIcon}</span>
                </button>`;
            });
            html += `</div></details>`;
            manualContainer.innerHTML += html;
        });

        // REFERENCIAS
        const els = {
            input: document.getElementById('inputText'),
            sheet: document.getElementById('sheet'),
            container: document.getElementById('linesContainer'),
            headerContainer: document.getElementById('headerContainer'),
            headerTitle: document.getElementById('headerTitleDisplay'),
            studentName: document.getElementById('studentNameDisplay'),
            schoolInput: document.getElementById('schoolName'),
            studentInput: document.getElementById('studentName'),
            counter: document.getElementById('lineCounter'),
            opacity: document.getElementById('opacityRange'),
            size: document.getElementById('sizeRange'),
            weight: document.getElementById('weightRange'),
            paper: document.getElementById('paperSelect'),
            font: document.getElementById('fontSelect'),
            opacityVal: document.getElementById('opacityVal'),
            sizeVal: document.getElementById('sizeVal'),
            weightVal: document.getElementById('weightVal'),
            checkHeader: document.getElementById('toggleHeader'),
            headerInputs: document.getElementById('headerInputs'),
            checkGrayscale: document.getElementById('toggleGrayscale'),
            songSelect: document.getElementById('songSelect'),
            youtubeContainer: document.getElementById('youtubeContainer'),
            bpmInput: document.getElementById('bpmInput'),
            metroBtn: document.getElementById('metroBtn'),
            modal: document.getElementById('pdfLoadingModal')
        };

        // --- C√ÅLCULO DE CAPACIDAD DIN√ÅMICA ---
        function calculateCapacity(currentSize, paperType) {
            const totalH = 1056; 
            const padH = 96; 
            const footerH = 20; 
            const headerH = els.checkHeader.checked ? 95 : 0;
            const availableH = totalH - padH - headerH - footerH;
            
            let rowH = currentSize;
            // Solo cuadr√≠cula ajusta su altura de rengl√≥n a m√∫ltiplos de 20
            if (paperType === 'bg-grid') {
                rowH = Math.max(20, Math.ceil(currentSize / 20) * 20);
            } 
            return Math.floor(availableH / rowH);
        }

        // RENDERIZADO
        function render() {
            saveState();
            if(!els.sheet || !els.container) return;

            const paperType = els.paper.value;
            const isGrayscale = els.checkGrayscale.checked;
            els.sheet.className = `sheet shadow-2xl origin-top ${paperType} ${isGrayscale ? 'grayscale-mode' : ''}`;
            
            const sizeVal = parseInt(els.size.value);
            const pt = Math.round(sizeVal * 0.75);
            if(els.sizeVal) els.sizeVal.textContent = `${sizeVal}px (‚âà${pt}pt)`;
            if(els.weightVal) els.weightVal.textContent = els.weight.value + 'x';
            if(els.opacityVal) els.opacityVal.textContent = els.opacity.value + '%';
            
            if (els.checkHeader.checked) {
                els.headerContainer.style.height = '25mm';
                els.headerContainer.style.opacity = '1';
                els.headerContainer.style.marginBottom = '0';
                els.headerTitle.textContent = els.schoolInput.value || "Caligraf√≠a";
                els.studentName.textContent = els.studentInput.value ? `${els.studentInput.value}` : "_________________";
                els.headerInputs.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                els.headerContainer.style.height = '0';
                els.headerContainer.style.opacity = '0';
                els.headerContainer.style.marginBottom = '0';
                els.headerInputs.classList.add('opacity-50', 'pointer-events-none');
            }

            maxLinesDynamic = calculateCapacity(sizeVal, paperType);
            
            els.container.innerHTML = '';
            const lines = els.input.value.split('\n');
            const fontClass = els.font.value;
            const practiceModeInput = document.querySelector('input[name="practiceMode"]:checked');
            const mode = practiceModeInput ? practiceModeInput.value : 'simple';
            let usedLines = 0;

            let rowHeightPx = sizeVal;
            // Solo cuadr√≠cula tiene snapping
            if (paperType === 'bg-grid') {
                 rowHeightPx = Math.max(20, Math.ceil(sizeVal / 20) * 20);
            } 

            document.documentElement.style.setProperty('--row-h', rowHeightPx + 'px');
            document.documentElement.style.setProperty('--font-s', (sizeVal * 0.66) + 'px');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if(!line && i === lines.length - 1) continue;

                let cost = (mode === 'plana') ? 2 : (mode === 'progressive' ? 3 : 1);
                if (usedLines + cost > maxLinesDynamic) break;

                const isGraphic = !!svgPaths[line];
                let effectiveColor = selectedColor;
                if (selectedColor === 'rainbow') effectiveColor = ['#000000', '#2563eb', '#dc2626'][i % 3];
                const finalColor = isGrayscale ? '#000000' : effectiveColor;

                if (mode === 'simple') {
                    createRow(line, els.opacity.value/100, isGraphic, finalColor, fontClass);
                } else if (mode === 'plana') {
                    createRow(line, els.opacity.value/100, isGraphic, finalColor, fontClass);
                    createRow('', 0, false, finalColor, fontClass);
                } else if (mode === 'progressive') {
                    createRow(line, 1, isGraphic, finalColor, fontClass);
                    createRow(line, 0.2, isGraphic, finalColor, fontClass);
                    createRow('', 0, false, finalColor, fontClass);
                }
                usedLines += cost;
            }

            if(els.counter) {
                els.counter.textContent = `${usedLines} / ${maxLinesDynamic}`;
                els.counter.className = usedLines >= maxLinesDynamic ? "text-xs font-mono font-bold text-red-400" : "text-xs font-mono font-bold text-green-400";
            }
        }

        function createRow(content, opacity, isPattern, color, fontClass) {
            const div = document.createElement('div');
            div.className = 'dynamic-row'; 
            
            if (isPattern) {
                div.className += ' svg-row';
                const svgContent = `<svg viewBox="0 0 40 60" preserveAspectRatio="none" style="height:100%; width:auto; stroke:${color}; stroke-width:${els.weight.value}; fill:none; opacity:${opacity}; display:block;">${svgPaths[content]}</svg>`;
                const svgContainer = document.createElement('div');
                svgContainer.className = 'row-svg';
                let html = '';
                for(let k=0; k<25; k++) html += svgContent;
                svgContainer.innerHTML = html;
                div.appendChild(svgContainer);
            } else if (!content) {
                div.innerHTML = '&nbsp;';
            } else {
                const span = document.createElement('span');
                span.className = `row-text ${fontClass}`;
                span.textContent = content;
                span.style.opacity = opacity;
                span.style.color = color;
                span.style.fontSize = (parseInt(els.size.value)) + 'px'; 
                div.appendChild(span);
            }
            els.container.appendChild(div);
        }

        function downloadPDF() {
            if(els.modal) els.modal.style.display = 'flex';
            const element = document.getElementById('sheet');
            const opt = {
                margin: 0,
                filename: `Caligrafia_${els.studentInput.value || 'Hoja'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            setTimeout(() => {
                html2pdf().set(opt).from(element).save().then(() => { if(els.modal) els.modal.style.display = 'none'; });
            }, 100);
        }

        function fillPage(type) {
            // L√≥gica aleatoria
            if (type === 'random') {
                const max = calculateCapacity(parseInt(els.size.value), els.paper.value);
                const allItems = [...categories.mix, ...categories.texto, "0 1 2 3 4 5 6 7 8 9"];
                let content = "";
                for(let i=0; i<max; i++) {
                     content += allItems[Math.floor(Math.random() * allItems.length)] + (i < max-1 ? '\n' : '');
                }
                els.input.value = content;
            } else {
                const max = calculateCapacity(parseInt(els.size.value), els.paper.value);
                const mode = document.querySelector('input[name="practiceMode"]:checked').value;
                const cost = mode === 'progressive' ? 3 : (mode === 'plana' ? 2 : 1);
                const slots = Math.floor(max / cost);

                let content = "";
                let list = categories[type];
                for(let i=0; i<slots; i++) {
                    content += list[i % list.length] + (i < slots-1 ? '\n' : '');
                }
                els.input.value = content;
            }
            render();
            if(window.innerWidth < 768) switchTab('preview');
        }

        function addGraphic(tag) { els.input.value += (els.input.value ? '\n' : '') + tag; render(); }
        
        function fillRemaining() {
            for(let i=0; i<10; i++) els.input.value += '\n{{OLAS}}';
            render();
        }

        function loadSong() {
            const songKey = els.songSelect.value;
            if (!songKey) return;
            const song = musicRep[songKey];
            els.schoolInput.value = "Dibujo R√≠tmico";
            els.studentInput.value = song.name; 
            
            const max = calculateCapacity(parseInt(els.size.value), els.paper.value);
            const mode = document.querySelector('input[name="practiceMode"]:checked').value;
            let cost = mode === 'progressive' ? 3 : (mode === 'plana' ? 2 : 1);
            let slots = Math.floor(max / cost);
            
            let content = "";
            for(let i=0; i<slots; i++) {
                content += song.patterns[i % song.patterns.length] + (i < slots-1 ? '\n' : '');
            }
            els.input.value = content;
            els.youtubeContainer.innerHTML = `<iframe width="100%" height="200" src="https://www.youtube.com/embed/${song.id}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            els.youtubeContainer.classList.remove('hidden');
            
            render();
            if(window.innerWidth < 768) switchTab('preview');
        }

        function resetAll() { 
            els.input.value = ''; 
            els.youtubeContainer.classList.add('hidden');
            els.youtubeContainer.innerHTML = '';
            render(); 
        }
        function setColor(c) { selectedColor = c; render(); }
        
        function switchTab(t) {
            const conf = document.getElementById('panelConfig');
            const prev = document.getElementById('panelPreview');
            if(t === 'config') { conf.classList.remove('hidden'); prev.classList.add('hidden'); prev.classList.remove('flex'); }
            else { conf.classList.add('hidden'); prev.classList.remove('hidden'); prev.classList.add('flex'); }
        }

        function toggleMetronome() {
            if(isMetronomeOn) {
                clearInterval(metronomeInterval);
                els.metroBtn.textContent = "‚ñ∂";
                isMetronomeOn = false;
            } else {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const bpm = parseInt(els.bpmInput.value) || 60;
                const intervalMs = 60000 / bpm;
                playClick();
                metronomeInterval = setInterval(playClick, intervalMs);
                els.metroBtn.textContent = "‚èπ";
                isMetronomeOn = true;
            }
        }

        function playClick() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = 1000;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        // Save/Load
        function saveState() {
            const practiceModeInput = document.querySelector('input[name="practiceMode"]:checked');
            const state = {
                text: els.input.value, size: els.size.value, opacity: els.opacity.value,
                font: els.font.value, paper: els.paper.value, school: els.schoolInput.value,
                student: els.studentInput.value, mode: practiceModeInput ? practiceModeInput.value : 'simple',
                color: selectedColor, showHeader: els.checkHeader.checked, grayscale: els.checkGrayscale.checked, weight: els.weight.value
            };
            localStorage.setItem('caligrafiaState', JSON.stringify(state));
        }
        function loadState() {
            const saved = localStorage.getItem('caligrafiaState');
            if (saved) {
                const state = JSON.parse(saved);
                if(state.text) els.input.value = state.text;
                if(state.size) els.size.value = state.size;
                if(state.opacity) els.opacity.value = state.opacity;
                if(state.font) els.font.value = state.font;
                if(state.paper) els.paper.value = state.paper;
                if(state.school) els.schoolInput.value = state.school;
                if(state.student) els.studentInput.value = state.student;
                if(state.color) selectedColor = state.color;
                if(state.weight) els.weight.value = state.weight;
                if(state.mode) {
                     const radio = document.querySelector(`input[name="practiceMode"][value="${state.mode}"]`);
                     if(radio) radio.checked = true;
                }
                if(state.showHeader !== undefined) els.checkHeader.checked = state.showHeader;
                if(state.grayscale !== undefined) els.checkGrayscale.checked = state.grayscale;
            }
        }

        const inputsUI = document.querySelectorAll('input, select, textarea');
        inputsUI.forEach(el => { el.addEventListener('input', render); });
        
        loadState();
        if(!els.input.value) fillPage('mix');
        if(window.innerWidth < 768) switchTab('preview');
        else { document.getElementById('panelConfig').classList.remove('hidden'); document.getElementById('panelPreview').classList.remove('hidden'); }
        render();
    </script>
</body>
</html>
