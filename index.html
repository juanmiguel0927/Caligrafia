<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Entrenador De Caligraf√≠a </title>
    
    <!-- FUENTES -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LIBRER√çA PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* --- ESTILOS GENERALES --- */
        body { background-color: #111827; color: #e5e7eb; }

        /* HOJA CARTA */
        .sheet {
            width: 8.5in;
            height: 11in;
            background-color: white;
            position: relative;
            padding: 0.5in 0.7in;
            box-sizing: border-box;
            margin: 0 auto;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            color: black;
        }

        /* PATRONES DE FONDO */
        .pattern-montessori { background-image: repeating-linear-gradient(to bottom, transparent 0px, transparent 19px, #bfdbfe 20px, transparent 21px, transparent 39px, #bfdbfe 40px, transparent 41px, transparent 59px, #e5e7eb 60px); background-size: 100% 60px; background-attachment: local; }
        .pattern-double { background-image: repeating-linear-gradient(to bottom, transparent 0px, transparent 24px, #93c5fd 25px, transparent 26px, transparent 34px, #93c5fd 35px, transparent 36px, transparent 59px, #e5e7eb 60px); background-size: 100% 60px; background-attachment: local; }
        .pattern-lines { background-image: repeating-linear-gradient(to bottom, transparent 0px, transparent 59px, #9ca3af 60px); background-size: 100% 60px; background-attachment: local; }
        .pattern-grid { background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px); background-size: 20px 20px; background-attachment: local; }

        /* MODO FOTOCOPIA */
        .grayscale-mode .pattern-montessori { background-image: repeating-linear-gradient(to bottom, transparent 0px, transparent 19px, #6b7280 20px, transparent 21px, transparent 39px, #6b7280 40px, transparent 41px, transparent 59px, #000 60px); }
        .grayscale-mode .pattern-double { background-image: repeating-linear-gradient(to bottom, transparent 0px, transparent 24px, #6b7280 25px, transparent 26px, transparent 34px, #6b7280 35px, transparent 36px, transparent 59px, #000 60px); }
        .grayscale-mode .text-row { color: black !important; }
        
        /* RENGLONES */
        #linesContainer { flex-grow: 1; width: 100%; position: relative; }
        .text-row { width: 100%; height: 60px; line-height: 60px; display: block; box-sizing: border-box; padding-top: 10px; white-space: nowrap; overflow: hidden; }
        .font-cursive { font-family: 'Dancing Script', cursive; padding-left: 8px; }
        .font-print { font-family: 'Lexend', sans-serif; letter-spacing: 1px; }

        /* SVG ROW */
        .svg-row { height: 60px; width: 100%; overflow: hidden; display: flex; align-items: flex-end; }
        
        /* UI */
        .btn-exercise { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; padding: 4px; height: 50px; transition: all 0.2s; border-radius: 6px; }
        /* Preview usando el mismo SVG inline pero escalado */
        .btn-preview { width: 100%; height: 25px; display: flex; justify-content: center; align-items: center; background-color: #e5e7eb; margin-bottom: 2px; overflow: hidden; }
        .btn-preview svg { height: 100%; width: auto; }
        
        details > summary { list-style: none; cursor: pointer; }
        
        @media (max-width: 768px) {
            .sheet { min-width: 8.5in; }
            #previewContainer { height: calc(100vh - 80px); background: #111827; padding: 10px; display: block; overflow: auto; -webkit-overflow-scrolling: touch; }
            #panelConfig { background-color: #0f172a; color: white; } 
        }
        @media (min-width: 769px) {
            #mobileTabs { display: none; }
            #panelConfig { display: flex !important; }
            #panelPreview { display: flex !important; }
        }
    </style>
</head>
<body class="bg-gray-900 h-screen overflow-hidden flex flex-col md:flex-row font-sans text-gray-100">

    <!-- PANEL LATERAL -->
    <aside id="panelConfig" class="w-full md:w-[420px] bg-gray-900 text-gray-100 shadow-xl z-20 flex flex-col h-full md:h-screen overflow-y-auto border-r border-gray-700 hidden md:flex relative">
        <div class="p-4 space-y-4 pb-24 md:pb-5">
            <div class="border-b border-gray-700 pb-2 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-blue-400">‚úçÔ∏è Caligraf√≠a Pro</h2>
                    <p class="text-[10px] text-gray-400">by Juan Miguel Rios Redondo</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.location.reload()" class="text-xs bg-blue-900/50 hover:bg-blue-800 text-blue-200 px-3 py-1 rounded border border-blue-800 flex items-center gap-1">üîÑ <span class="hidden md:inline">Recargar</span></button>
                    <button onclick="resetAll()" class="text-xs bg-red-900/50 hover:bg-red-800 text-red-200 px-3 py-1 rounded border border-red-800">Borrar</button>
                </div>
            </div>

            <!-- SECCI√ìN MUSICAL -->
            <div class="bg-indigo-900/30 p-3 rounded-lg border border-indigo-800">
                <label class="text-[10px] text-indigo-300 uppercase font-bold block mb-2">üéµ Dibujo R√≠tmico</label>
                <div class="flex gap-2 mb-2">
                    <select id="songSelect" class="w-full bg-gray-900 border border-gray-600 text-gray-200 rounded p-1 text-xs">
                        <option value="">Selecciona obra...</option>
                        <optgroup label="1. Rectos y Marcados">
                            <option value="radetzky">1. Marcha Radetzky</option>
                            <option value="marcha_turca">2. Marcha Turca</option>
                            <option value="guillermo_tell">3. Guillermo Tell</option>
                            <option value="toreros">4. Marcha Toreros</option>
                            <option value="sable">5. Danza del Sable</option>
                            <option value="montescos">6. Montescos y Capuletos</option>
                        </optgroup>
                        <optgroup label="2. Curvas y Ondas">
                            <option value="danubio">7. El Danubio Azul</option>
                            <option value="cisne">8. El Cisne</option>
                            <option value="acuario">9. Acuario</option>
                            <option value="manana">10. La Ma√±ana (Grieg)</option>
                            <option value="thais">11. Meditaci√≥n de Thais</option>
                            <option value="bach_air">12. Air on G String</option>
                        </optgroup>
                        <optgroup label="3. Bucles y Espirales">
                            <option value="moscardon">13. Vuelo del Moscard√≥n</option>
                            <option value="flores">14. Vals de las Flores</option>
                            <option value="primavera">15. La Primavera</option>
                            <option value="tritsch">16. Tritsch-Tratsch Polka</option>
                            <option value="badinerie">17. Badinerie</option>
                        </optgroup>
                        <optgroup label="4. Puntos y Staccato">
                            <option value="pizzicato">18. Pizzicato Polka</option>
                            <option value="maquina">19. M√°quina de Escribir</option>
                            <option value="plink">20. Plink, Plank, Plunk</option>
                            <option value="hada">21. Hada de Az√∫car</option>
                            <option value="popcorn">22. Popcorn</option>
                        </optgroup>
                        <optgroup label="5. Mixtos">
                            <option value="rey_montana">23. Rey de la Monta√±a</option>
                            <option value="pantera">24. Pantera Rosa</option>
                            <option value="elephant">25. Baby Elephant Walk</option>
                            <option value="esqueletos">26. Marcha Esqueletos</option>
                            <option value="fosiles">27. F√≥siles</option>
                            <option value="hungara">28. Danza H√∫ngara 5</option>
                            <option value="cancan">29. Can Can</option>
                            <option value="gladiadores">30. Gladiadores</option>
                        </optgroup>
                    </select>
                    <button onclick="loadSong()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 rounded text-xs font-bold">Cargar</button>
                </div>
                <div id="youtubeContainer" class="hidden text-[10px] text-center mt-2 flex gap-2 items-center">
                    <a id="youtubeLink" href="#" target="_blank" class="flex-grow text-center text-indigo-400 underline hover:text-indigo-300 bg-gray-900 border border-gray-600 rounded p-1">‚ñ∂Ô∏è Ver en YouTube</a>
                    <div class="flex items-center gap-1 bg-gray-800 rounded p-1 border border-gray-600">
                        <button id="metroBtn" onclick="toggleMetronome()" class="text-xs px-2 py-0.5 bg-gray-600 rounded hover:bg-gray-500">‚ñ∂</button>
                        <input type="number" id="bpmInput" value="60" class="w-8 text-xs bg-transparent text-center outline-none">
                    </div>
                </div>
            </div>

            <!-- CONTADOR -->
            <div class="bg-gray-800 p-2 rounded border border-gray-600 flex justify-between items-center">
                <span class="text-xs font-bold text-gray-300 uppercase">Ocupaci√≥n Hoja:</span>
                <span id="lineCounter" class="text-xs font-mono font-bold text-green-400">0 / 13</span>
            </div>

            <!-- GENERADORES -->
            <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
                <label class="text-[10px] text-gray-400 uppercase font-bold block mb-2">Generar Rutina</label>
                <div class="grid grid-cols-5 gap-2">
                    <button onclick="fillPage('rectos')" class="p-2 bg-blue-900/30 hover:bg-blue-800 border border-blue-800 rounded flex flex-col items-center"><span class="text-lg">üìè</span></button>
                    <button onclick="fillPage('curvas')" class="p-2 bg-green-900/30 hover:bg-green-800 border border-green-800 rounded flex flex-col items-center"><span class="text-lg">d o</span></button>
                    <button onclick="fillPage('bucles')" class="p-2 bg-orange-900/30 hover:bg-orange-800 border border-orange-800 rounded flex flex-col items-center"><span class="text-lg">‚û∞</span></button>
                    <button onclick="fillPage('mix')" class="p-2 bg-purple-900/30 hover:bg-purple-800 border border-purple-800 rounded flex flex-col items-center"><span class="text-lg">üîÄ</span></button>
                    <button onclick="fillPage('texto')" class="p-2 bg-gray-700 hover:bg-gray-600 border border-gray-600 rounded flex flex-col items-center"><span class="text-lg">üìù</span></button>
                </div>
            </div>

            <!-- ACORDEONES MANUALES -->
            <details class="group bg-gray-800 rounded-lg border border-gray-700"><summary class="p-2 font-bold text-[10px] uppercase text-blue-300 hover:bg-gray-700 flex justify-between select-none">1. Trazos Rectos<span class="transform group-open:rotate-180">‚ñº</span></summary><div class="p-2 grid grid-cols-4 gap-2 bg-gray-900/50" id="btnGroupRectos"></div></details>
            <details class="group bg-gray-800 rounded-lg border border-gray-700"><summary class="p-2 font-bold text-[10px] uppercase text-green-300 hover:bg-gray-700 flex justify-between select-none">2. Curvas<span class="transform group-open:rotate-180">‚ñº</span></summary><div class="p-2 grid grid-cols-4 gap-2 bg-gray-900/50" id="btnGroupCurvas"></div></details>
            <details class="group bg-gray-800 rounded-lg border border-gray-700"><summary class="p-2 font-bold text-[10px] uppercase text-orange-300 hover:bg-gray-700 flex justify-between select-none">3. Bucles<span class="transform group-open:rotate-180">‚ñº</span></summary><div class="p-2 grid grid-cols-4 gap-2 bg-gray-900/50" id="btnGroupBucles"></div></details>

            <!-- INPUT -->
            <div>
                 <textarea id="inputText" rows="2" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-mono text-gray-200" placeholder="Escribe aqu√≠..."></textarea>
                 <button onclick="fillRemaining()" class="w-full mt-2 text-xs bg-indigo-700 hover:bg-indigo-600 text-white p-2 rounded font-bold transition">‚ú® Rellenar Espacio Restante</button>
            </div>

            <!-- AJUSTES -->
            <div class="bg-gray-800 p-3 rounded-lg border border-gray-700 space-y-3">
                <div class="flex justify-between items-center text-[10px] border-b border-gray-700 pb-2">
                    <label class="flex items-center text-gray-400 font-bold"><input type="checkbox" id="toggleHeader" checked onchange="render()" class="accent-blue-500 mr-1"> Encabezado</label>
                    <label class="flex items-center text-gray-400 font-bold"><input type="checkbox" id="toggleGrayscale" onchange="render()" class="accent-gray-500 mr-1"> B&N</label>
                </div>

                <div class="grid grid-cols-3 gap-1 text-[10px]">
                    <label class="flex items-center cursor-pointer"><input type="radio" name="practiceMode" value="simple" checked onchange="render()" class="accent-blue-500 mr-1"> Simple</label>
                    <label class="flex items-center cursor-pointer"><input type="radio" name="practiceMode" value="plana" onchange="render()" class="accent-blue-500 mr-1"> Alterno</label>
                    <label class="flex items-center cursor-pointer"><input type="radio" name="practiceMode" value="progressive" onchange="render()" class="accent-blue-500 mr-1"> Progresivo</label>
                </div>
                
                <div id="headerInputs" class="flex gap-2">
                    <input type="text" id="schoolName" placeholder="Colegio" class="w-1/2 bg-gray-900 border border-gray-600 text-gray-300 text-[10px] rounded p-1">
                    <input type="text" id="studentName" placeholder="Alumno" class="w-1/2 bg-gray-900 border border-gray-600 text-gray-300 text-[10px] rounded p-1">
                </div>

                <div class="flex gap-2 justify-center pt-2 border-t border-gray-700">
                    <button onclick="setColor('black')" class="w-5 h-5 rounded-full bg-black border border-gray-500 ring-1 ring-white/20"></button>
                    <button onclick="setColor('#2563eb')" class="w-5 h-5 rounded-full bg-blue-600 border border-gray-500 ring-1 ring-white/20"></button>
                    <button onclick="setColor('#dc2626')" class="w-5 h-5 rounded-full bg-red-600 border border-gray-500 ring-1 ring-white/20"></button>
                    <button onclick="setColor('rainbow')" class="w-5 h-5 rounded-full bg-gradient-to-r from-blue-500 to-red-500 border border-gray-500 ring-1 ring-white/20" title="Alternar"></button>
                </div>

                <!-- CONTROLES T√âCNICOS -->
                <div class="grid grid-cols-2 gap-2 border-t border-gray-700 pt-2">
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-[10px] text-gray-400 uppercase font-bold">Opacidad</label>
                            <span id="opacityVal" class="text-[9px] font-mono text-blue-300">30%</span>
                        </div>
                        <input type="range" id="opacityRange" min="10" max="100" value="30" class="w-full h-1 bg-gray-600 rounded accent-blue-400">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-[10px] text-gray-400 uppercase font-bold">Tama√±o</label>
                            <span id="sizeVal" class="text-[9px] font-mono text-blue-300">30px</span>
                        </div>
                        <input type="range" id="sizeRange" min="16" max="80" value="30" class="w-full h-1 bg-gray-600 rounded accent-blue-400">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-[10px] text-gray-400 uppercase font-bold">Grosor</label>
                            <span id="weightVal" class="text-[9px] font-mono text-blue-300">Normal</span>
                        </div>
                        <input type="range" id="weightRange" min="1" max="5" step="0.5" value="1.5" class="w-full h-1 bg-gray-600 rounded accent-blue-400">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                     <div>
                        <label class="text-[10px] text-gray-400 uppercase font-bold mb-1 block">Papel</label>
                        <select id="paperSelect" class="w-full bg-gray-900 border border-gray-600 text-gray-300 rounded p-1 text-[10px]">
                            <option value="pattern-montessori">Montessori</option>
                            <option value="pattern-double">Doble Rayada</option>
                            <option value="pattern-lines">Rayado</option>
                            <option value="pattern-grid">Cuadr√≠cula</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 uppercase font-bold mb-1 block">Fuente</label>
                        <select id="fontSelect" class="w-full bg-gray-900 border border-gray-600 text-gray-300 rounded p-1 text-[10px]">
                            <option value="font-cursive">Cursiva</option>
                            <option value="font-print">Imprenta</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="text-center pt-2 border-t border-gray-700">
                <p class="text-[10px] text-gray-500">Desarrollado por <strong class="text-gray-400">Juan Miguel Rios Redondo</strong></p>
            </div>
        </div>
    </aside>

    <!-- PREVIEW AREA -->
    <main id="panelPreview" class="flex-1 bg-gray-800 h-full overflow-hidden flex flex-col relative hidden md:flex">
        <div class="md:hidden bg-gray-900 text-white p-2 text-center text-xs font-bold uppercase tracking-widest shadow z-10 flex justify-between items-center px-4 no-print">
            <span>Vista Previa</span>
            <button onclick="downloadPDF()" class="text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded font-bold">Guardar PDF</button>
        </div>

        <div id="previewContainer" class="flex-1 w-full flex justify-center p-0 md:p-8 overflow-auto">
            <div id="sheet" class="sheet pattern-montessori shadow-2xl origin-top">
                <div class="flex-grow flex flex-col h-full">
                    <div id="headerContainer" class="flex flex-col items-center border-b-2 border-gray-800 pb-2 mb-0 h-[25mm] justify-end flex-shrink-0 transition-all duration-300 overflow-hidden">
                        <h1 id="headerTitleDisplay" class="text-xl font-bold text-gray-800 uppercase tracking-wide font-sans w-full text-center">Caligraf√≠a</h1>
                        <div class="w-full flex justify-between text-sm text-gray-500 mt-1 font-mono">
                            <span id="studentNameDisplay">Alumno: _________________</span>
                            <span>Fecha: _______</span>
                        </div>
                    </div>
                    <div id="linesContainer" class="w-full relative flex-grow"></div>
                </div>
                <div class="mt-auto pt-1 border-t border-gray-300 text-center flex-shrink-0">
                    <p class="text-[8px] text-gray-400 font-sans">Material educativo creado con el Entrenador de Caligraf√≠a de Juan Miguel Rios Redondo</p>
                </div>
            </div>
        </div>
        <button id="printFloatBtn" onclick="downloadPDF()" class="absolute bottom-24 right-6 md:bottom-10 md:right-10 bg-red-600 text-white p-4 rounded-full shadow-lg z-50 hover:bg-red-500 transition-all transform hover:scale-110 border-2 border-white no-print shadow-xl">
            <span class="text-xs font-bold block text-center">PDF</span>
            ‚¨áÔ∏è
        </button>
    </main>

    <!-- TABS M√ìVIL -->
    <nav id="mobileTabs" class="fixed bottom-0 w-full bg-gray-900 border-t border-gray-800 flex justify-around py-2 z-50 shadow-lg md:hidden h-16 no-print">
        <button onclick="switchTab('config')" id="tabConfig" class="flex flex-col items-center justify-center text-blue-400 w-1/2"><span class="text-xl mb-1">üõ†Ô∏è</span><span class="text-[10px] font-bold">EDITOR</span></button>
        <button onclick="switchTab('preview')" id="tabPreview" class="flex flex-col items-center justify-center text-gray-400 w-1/2"><span class="text-xl mb-1">üìÑ</span><span class="text-[10px] font-bold">HOJA</span></button>
    </nav>

    <script>
        // DEFINICI√ìN DE SVG PATHS (Para inline SVG y coloreado correcto)
        const svgPaths = {
            '{{VERT}}': '<line x1="7.5" y1="15" x2="7.5" y2="45"/>',
            '{{INCL}}': '<line x1="12" y1="15" x2="3" y2="45"/>',
            '{{GUION}}': '<line x1="2" y1="30" x2="23" y2="30"/>',
            '{{ALMENA}}': '<path d="M0,45 L0,20 L15,20 L15,45 L30,45" fill="none"/>',
            '{{ZIGZAG}}': '<path d="M0,45 L10,15 L20,45" fill="none"/>',
            '{{L_SHAPE}}': '<path d="M5,15 L5,40 Q5,45 15,45" fill="none"/>',
            '{{U_SHAPE}}': '<path d="M2,20 Q10,55 18,20" fill="none"/>',
            '{{ARCH}}': '<path d="M2,45 Q10,10 18,45" fill="none"/>',
            '{{C_SHAPE}}': '<path d="M18,20 Q2,32.5 18,45" fill="none"/>',
            '{{C_REV}}': '<path d="M2,20 Q18,32.5 2,45" fill="none"/>',
            '{{CIRCLE}}': '<circle cx="12.5" cy="32.5" r="8" fill="none"/>',
            '{{J_HOOK}}': '<path d="M15,20 L15,45 Q15,55 5,50" fill="none"/>',
            '{{BUCLE_E}}': '<path d="M0,45 Q5,45 5,35 Q5,25 10,25 Q15,25 15,35 Q15,45 20,45" fill="none"/>',
            '{{BUCLE_L}}': '<path d="M0,45 Q10,45 10,10 Q10,10 20,45" fill="none"/>',
            '{{OLAS}}': '<path d="M0,35 Q7.5,20 15,35 T30,35" fill="none"/>',
            '{{MUELLE}}': '<path d="M0,40 Q7.5,10 15,40" fill="none"/>',
            '{{ESPIRAL}}': '<path d="M5,40 C5,25 35,25 35,40 C35,50 15,50 15,35 C15,30 25,30 25,35" fill="none"/>',
            '{{ROMBOS}}': '<path d="M0,32.5 L15,15 L30,32.5 L15,50 L0,32.5" fill="none"/>'
        };

        // Generaci√≥n de botones din√°micos
        const buttonConfig = {
            'btnGroupRectos': ['{{VERT}}', '{{INCL}}', '{{GUION}}', '{{ALMENA}}', '{{ZIGZAG}}', '{{L_SHAPE}}'],
            'btnGroupCurvas': ['{{U_SHAPE}}', '{{ARCH}}', '{{C_SHAPE}}', '{{C_REV}}', '{{CIRCLE}}', '{{J_HOOK}}'],
            'btnGroupBucles': ['{{BUCLE_E}}', '{{BUCLE_L}}', '{{OLAS}}', '{{MUELLE}}', '{{ESPIRAL}}', '{{ROMBOS}}']
        };

        const categories = {
            rectos: buttonConfig.btnGroupRectos,
            curvas: buttonConfig.btnGroupCurvas,
            bucles: buttonConfig.btnGroupBucles,
            mix: Object.keys(svgPaths),
            texto: ["Aa Bb Cc Dd Ee", "Ff Gg Hh Ii Jj", "Kk Ll Mm Nn √ë√±", "Oo Pp Qq Rr Ss", "Tt Uu Vv Ww Xx", "Yy Zz 0 1 2 3 4"]
        };

        // Repertorio musical (misma data que antes)
        const musicRep = {
            'marcha_turca': { name: "Marcha Turca (Mozart)", link: "https://www.youtube.com/watch?v=7bCl6MnQ8bw", patterns: ['{{ZIGZAG}}', '{{VERT}}', '{{ALMENA}}', '{{ZIGZAG}}'] },
            'radetzky': { name: "Marcha Radetzky", link: "https://www.youtube.com/watch?v=XzP2ThLUSCk", patterns: ['{{VERT}}', '{{GUION}}', '{{L_SHAPE}}', '{{VERT}}'] },
            'toreros': { name: "Marcha Toreros (Carmen)", link: "https://www.youtube.com/watch?v=4DNGMoMNLRY", patterns: ['{{ALMENA}}', '{{L_SHAPE}}', '{{VERT}}', '{{ALMENA}}'] },
            'guillermo_tell': { name: "Guillermo Tell (Finale)", link: "https://www.youtube.com/watch?v=YIbYCOiETx0", patterns: ['{{INCL}}', '{{GUION}}', '{{INCL}}', '{{VERT}}'] },
            'sable': { name: "Danza del Sable", link: "https://www.youtube.com/watch?v=gqg3l3r_DRI", patterns: ['{{ZIGZAG}}', '{{INCL}}', '{{ZIGZAG}}', '{{VERT}}'] },
            'montescos': { name: "Montescos y Capuletos", link: "https://www.youtube.com/watch?v=Z_hOR50u7ek", patterns: ['{{GUION}}', '{{L_SHAPE}}', '{{VERT}}', '{{GUION}}'] },
            'danubio': { name: "El Danubio Azul", link: "https://www.youtube.com/watch?v=dJCwYESbFOw", patterns: ['{{OLAS}}', '{{ARCH}}', '{{U_SHAPE}}', '{{OLAS}}'] },
            'cisne': { name: "El Cisne (Saint-Sa√´ns)", link: "https://www.youtube.com/watch?v=3qrKjywjo7Q", patterns: ['{{U_SHAPE}}', '{{OLAS}}', '{{ARCH}}', '{{U_SHAPE}}'] },
            'acuario': { name: "Acuario (Saint-Sa√´ns)", link: "https://www.youtube.com/watch?v=AsD0FDLOKGA", patterns: ['{{ESPIRAL}}', '{{CIRCLE}}', '{{U_SHAPE}}', '{{ESPIRAL}}'] },
            'manana': { name: "La Ma√±ana (Grieg)", link: "https://www.youtube.com/watch?v=-rh8gMvzKw0", patterns: ['{{ARCH}}', '{{CIRCLE}}', '{{U_SHAPE}}', '{{ARCH}}'] },
            'thais': { name: "Meditaci√≥n de Thais", link: "https://www.youtube.com/watch?v=PGd4rs-b6IA", patterns: ['{{OLAS}}', '{{C_SHAPE}}', '{{U_SHAPE}}', '{{OLAS}}'] },
            'bach_air': { name: "Air on G String", link: "https://www.youtube.com/watch?v=GMkmQlfkNIk", patterns: ['{{GUION}}', '{{OLAS}}', '{{GUION}}', '{{U_SHAPE}}'] },
            'moscardon': { name: "El Vuelo del Moscard√≥n", link: "https://www.youtube.com/watch?v=aYAJopwEYv8", patterns: ['{{BUCLE_E}}', '{{ESPIRAL}}', '{{BUCLE_E}}', '{{MUELLE}}'] },
            'flores': { name: "Vals de las Flores", link: "https://www.youtube.com/watch?v=QxHk_3yzt3c", patterns: ['{{BUCLE_L}}', '{{OLAS}}', '{{BUCLE_L}}', '{{ARCH}}'] },
            'primavera': { name: "La Primavera (Vivaldi)", link: "https://www.youtube.com/watch?v=l-dYNttdgl0", patterns: ['{{BUCLE_L}}', '{{ROMBOS}}', '{{U_SHAPE}}', '{{BUCLE_L}}'] },
            'tritsch': { name: "Tritsch-Tratsch Polka", link: "https://www.youtube.com/watch?v=7uV3X8y1YEQ", patterns: ['{{ESPIRAL}}', '{{BUCLE_E}}', '{{ESPIRAL}}', '{{ZIGZAG}}'] },
            'badinerie': { name: "Badinerie (Bach)", link: "https://www.youtube.com/watch?v=xVxwT78V9gw", patterns: ['{{BUCLE_E}}', '{{ROMBOS}}', '{{BUCLE_E}}', '{{ZIGZAG}}'] },
            'pizzicato': { name: "Pizzicato Polka", link: "https://www.youtube.com/watch?v=R_xrkenwf3I", patterns: ['{{GUION}}', '{{CIRCLE}}', '{{GUION}}', '{{CIRCLE}}'] },
            'maquina': { name: "La M√°quina de Escribir", link: "https://www.youtube.com/watch?v=G4nX0Xrn-wo", patterns: ['{{CIRCLE}}', '{{GUION}}', '{{CIRCLE}}', '{{GUION}}'] },
            'plink': { name: "Plink, Plank, Plunk", link: "https://www.youtube.com/watch?v=e1k3B2d5q5w", patterns: ['{{CIRCLE}}', '{{VERT}}', '{{CIRCLE}}', '{{VERT}}'] },
            'hada': { name: "Danza Hada de Az√∫car", link: "https://www.youtube.com/watch?v=Wz_f9B4pPtg", patterns: ['{{CIRCLE}}', '{{U_SHAPE}}', '{{CIRCLE}}', '{{ARCH}}'] },
            'popcorn': { name: "Popcorn", link: "https://www.youtube.com/watch?v=NjxwkZ1s7BA", patterns: ['{{CIRCLE}}', '{{ZIGZAG}}', '{{CIRCLE}}', '{{ZIGZAG}}'] },
            'rey_montana': { name: "Rey de la Monta√±a", link: "https://www.youtube.com/watch?v=kLp_Hh6DKWc", patterns: ['{{CIRCLE}}', '{{GUION}}', '{{ZIGZAG}}', '{{ESPIRAL}}'] },
            'pantera': { name: "Pantera Rosa", link: "https://www.youtube.com/watch?v=jBupII3LH_Q", patterns: ['{{GUION}}', '{{L_SHAPE}}', '{{GUION}}', '{{L_SHAPE}}'] },
            'elephant': { name: "Baby Elephant Walk", link: "https://www.youtube.com/watch?v=b1z4J_dJ8d4", patterns: ['{{ARCH}}', '{{GUION}}', '{{ARCH}}', '{{GUION}}'] },
            'esqueletos': { name: "Marcha de Esqueletos", link: "https://www.youtube.com/watch?v=z0glKOLU5iA", patterns: ['{{VERT}}', '{{CIRCLE}}', '{{VERT}}', '{{CIRCLE}}'] },
            'fosiles': { name: "F√≥siles (Saint-Sa√´ns)", link: "https://www.youtube.com/watch?v=vJ0j3j7j_4g", patterns: ['{{INCL}}', '{{ZIGZAG}}', '{{INCL}}', '{{ZIGZAG}}'] },
            'hungara': { name: "Danza H√∫ngara No. 5", link: "https://www.youtube.com/watch?v=3X9LvC9WkkQ", patterns: ['{{OLAS}}', '{{ZIGZAG}}', '{{OLAS}}', '{{ZIGZAG}}'] },
            'cancan': { name: "Can Can", link: "https://www.youtube.com/watch?v=4DNGMoMNLRY", patterns: ['{{VERT}}', '{{INCL}}', '{{VERT}}', '{{INCL}}'] },
            'gladiadores': { name: "Entrada Gladiadores", link: "https://www.youtube.com/watch?v=_B0CyOAO8y0", patterns: ['{{ESPIRAL}}', '{{OLAS}}', '{{ESPIRAL}}', '{{OLAS}}'] }
        };

        let selectedColor = '#000000'; 
        let maxLinesDynamic = 13;
        let audioCtx = null;
        let metronomeInterval = null;
        let isMetronomeOn = false;

        // Render Buttons
        Object.keys(buttonConfig).forEach(groupId => {
            const container = document.getElementById(groupId);
            buttonConfig[groupId].forEach(tag => {
                const btn = document.createElement('button');
                btn.className = "btn-exercise bg-gray-800 border border-gray-600 hover:bg-gray-700";
                btn.onclick = () => addGraphic(tag);
                // Create SVG preview
                const svgStr = `<svg viewBox="0 0 40 60" preserveAspectRatio="none" style="width:100%;height:100%;stroke:currentColor;stroke-width:2;">${svgPaths[tag]}</svg>`;
                btn.innerHTML = `<span class="btn-preview bg-gray-300 text-black">${svgStr}</span><span class="text-[9px] mt-1 text-gray-400">${tag.replace(/[{}]/g, '')}</span>`;
                container.appendChild(btn);
            });
        });

        // --- RENDER LOGIC ---
        const els = {
            input: document.getElementById('inputText'),
            sheet: document.getElementById('sheet'),
            container: document.getElementById('linesContainer'),
            headerContainer: document.getElementById('headerContainer'),
            headerTitle: document.getElementById('headerTitleDisplay'),
            studentName: document.getElementById('studentNameDisplay'),
            schoolInput: document.getElementById('schoolName'),
            studentInput: document.getElementById('studentName'),
            counter: document.getElementById('lineCounter'),
            opacity: document.getElementById('opacityRange'),
            size: document.getElementById('sizeRange'),
            weight: document.getElementById('weightRange'),
            paper: document.getElementById('paperSelect'),
            font: document.getElementById('fontSelect'),
            opacityVal: document.getElementById('opacityVal'),
            sizeVal: document.getElementById('sizeVal'),
            weightVal: document.getElementById('weightVal'),
            checkHeader: document.getElementById('toggleHeader'),
            checkGrayscale: document.getElementById('toggleGrayscale'),
            songSelect: document.getElementById('songSelect'),
            youtubeContainer: document.getElementById('youtubeContainer'),
            youtubeLink: document.getElementById('youtubeLink'),
            bpmInput: document.getElementById('bpmInput'),
            metroBtn: document.getElementById('metroBtn')
        };

        function render() {
            saveState();

            // Configurar Hoja
            const isGrayscale = els.checkGrayscale.checked;
            els.sheet.className = `sheet shadow-2xl origin-top ${els.paper.value} ${isGrayscale ? 'grayscale-mode' : ''}`;
            
            // Configurar Grosor y UI
            els.weightVal.textContent = els.weight.value + 'x';
            
            const showHeader = els.checkHeader.checked;
            if (showHeader) {
                els.headerContainer.style.height = '25mm';
                els.headerContainer.style.opacity = '1';
                els.headerContainer.style.marginBottom = '0';
                els.headerTitle.textContent = els.schoolInput.value || "Caligraf√≠a";
                els.studentName.textContent = els.studentInput.value ? `Alumno: ${els.studentInput.value}` : "Alumno: _________________";
                document.getElementById('headerInputs').classList.remove('opacity-50', 'pointer-events-none');
                maxLinesDynamic = 13; 
            } else {
                els.headerContainer.style.height = '0';
                els.headerContainer.style.opacity = '0';
                els.headerContainer.style.marginBottom = '0';
                document.getElementById('headerInputs').classList.add('opacity-50', 'pointer-events-none');
                maxLinesDynamic = 15; 
            }

            const sizePx = els.size.value;
            const sizePt = Math.round(sizePx * 0.75);
            els.opacityVal.textContent = els.opacity.value + '%';
            els.sizeVal.textContent = `${sizePx}px (‚âà${sizePt}pt)`;

            const mode = document.querySelector('input[name="practiceMode"]:checked').value;
            const lines = els.input.value.split('\n');
            let usedLines = 0;
            
            els.container.innerHTML = ''; 

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line && i === lines.length - 1) continue; 

                let cost = 1;
                if (mode === 'plana') cost = 2;
                if (mode === 'progressive') cost = 3;

                if (usedLines + cost > maxLinesDynamic) break;

                const isGraphic = !!svgPaths[line];
                
                let effectiveColor = selectedColor;
                if (selectedColor === 'rainbow') {
                    const colors = ['#000000', '#2563eb', '#dc2626'];
                    effectiveColor = colors[i % 3];
                }
                
                if (mode === 'simple') {
                    createRow(line, els.opacity.value / 100, isGraphic, effectiveColor);
                } else if (mode === 'plana') {
                    createRow(line, els.opacity.value / 100, isGraphic, effectiveColor);
                    createRow('', 0, false, effectiveColor); 
                } else if (mode === 'progressive') {
                    createRow(line, 1, isGraphic, effectiveColor); 
                    createRow(line, 0.2, isGraphic, effectiveColor); 
                    createRow('', 0, false, effectiveColor); 
                }
                
                usedLines += cost;
            }

            els.counter.textContent = `${usedLines} / ${maxLinesDynamic}`;
            els.counter.className = usedLines >= maxLinesDynamic ? "text-xs font-mono font-bold text-red-400" : "text-xs font-mono font-bold text-green-400";
        }

        function createRow(content, opacity = 1, isPattern = false, color = '#000000') {
            const div = document.createElement('div');
            const finalColor = els.checkGrayscale.checked ? '#000000' : color;
            
            if (isPattern) {
                div.className = 'svg-row';
                // Generar Inline SVG Real
                const weight = els.weight.value;
                const widthDefault = content === '{{DASH}}' ? 25 : (content.includes('BUCLE') || content.includes('ESPIRAL') ? 40 : 20); // Ajuste ancho base
                
                const svgContent = `<svg viewBox="0 0 ${widthDefault} 60" preserveAspectRatio="none" 
                    style="width:100%; height:60px; fill:none; stroke:${finalColor}; stroke-width:${weight}; opacity:${opacity}; display:block;">
                    <pattern id="pat-${content}-${Math.random()}" patternUnits="userSpaceOnUse" width="${widthDefault}" height="60">
                       ${svgPaths[content].replace(/stroke='[^']*'/g, '').replace(/stroke-width='[^']*'/g, '')} 
                    </pattern>
                    <rect width="100%" height="100%" fill="url(#pat-${content}-${Math.random()})" />
                    <!-- Fallback: Repetir manual via JS (mejor para html2pdf) -->
                    ${generateRepeatedPath(svgPaths[content], widthDefault)}
                </svg>`;
                
                // Opci√≥n B: Usar repeat-x de background con SVG Data URI codificado (M√°s compatible con html2pdf si inline falla)
                // Pero inline es mejor para colores.
                // Soluci√≥n html2pdf: Construir un div con flex y muchos SVGs peque√±os
                
                div.innerHTML = "";
                div.style.display = "flex";
                div.style.overflow = "hidden";
                
                // Repetir el SVG para llenar la l√≠nea
                const count = Math.ceil(800 / widthDefault); 
                for(let k=0; k<count; k++) {
                    div.innerHTML += `<svg viewBox="0 0 ${widthDefault} 60" width="${widthDefault}" height="60" style="flex-shrink:0; overflow:visible; opacity:${opacity};">
                        <g stroke="${finalColor}" stroke-width="${weight}" fill="none">
                            ${svgPaths[content]}
                        </g>
                    </svg>`;
                }

            } else if (!content) {
                div.className = 'text-row';
                div.innerHTML = '&nbsp;';
            } else {
                const font = els.font.value === 'font-cursive' ? 'font-cursive' : 'font-print';
                const span = document.createElement('span');
                span.className = `text-row ${font}`;
                span.textContent = content;
                span.style.color = finalColor;
                span.style.opacity = opacity;
                span.style.fontSize = els.size.value + 'px';
                span.style.fontWeight = els.weight.value > 2 ? 'bold' : 'normal'; 
                div.appendChild(span);
            }
            els.container.appendChild(div);
        }
        
        function generateRepeatedPath(pathStr, width) {
            return ''; // Usamos el bucle for en createRow mejor
        }

        function downloadPDF() {
            const element = document.getElementById('sheet');
            
            const opt = {
                margin: 0,
                filename: `Caligrafia_${els.studentInput.value || 'Practica'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            // Workaround para asegurar renderizado correcto
            // Clonar nodo y asegurar estilos antes de PDF
            html2pdf().set(opt).from(element).save();
        }

        function addGraphic(tag) {
            const currentLines = els.input.value.split('\n').filter(l => l).length;
            const mode = document.querySelector('input[name="practiceMode"]:checked').value;
            const cost = mode === 'progressive' ? 3 : (mode === 'plana' ? 2 : 1);
            if ((currentLines + 1) * cost > maxLinesDynamic) { alert("¬°Hoja llena!"); return; }
            els.input.value += (els.input.value ? '\n' : '') + tag;
            render();
        }

        function fillPage(type) {
            const mode = document.querySelector('input[name="practiceMode"]:checked').value;
            let cost = mode === 'progressive' ? 3 : (mode === 'plana' ? 2 : 1);
            let availableSlots = Math.floor(maxLinesDynamic / cost);
            let content = "";
            let list = categories[type];
            for(let i=0; i<availableSlots; i++) {
                content += list[i % list.length] + (i < availableSlots-1 ? '\n' : '');
            }
            els.input.value = content;
            render();
            if(window.innerWidth < 768) switchTab('preview');
        }

        function loadSong() {
            const songKey = els.songSelect.value;
            if (!songKey) return;
            
            const song = musicRep[songKey];
            els.schoolInput.value = "Dibujo R√≠tmico";
            els.studentInput.value = song.name;
            
            const mode = document.querySelector('input[name="practiceMode"]:checked').value;
            let cost = mode === 'progressive' ? 3 : (mode === 'plana' ? 2 : 1);
            let availableSlots = Math.floor(maxLinesDynamic / cost);
            
            let content = "";
            for(let i=0; i<availableSlots; i++) {
                content += song.patterns[i % song.patterns.length] + (i < availableSlots-1 ? '\n' : '');
            }
            
            els.input.value = content;
            
            // Mostrar enlace
            els.youtubeContainer.classList.remove('hidden');
            els.youtubeLink.href = song.link;
            
            render();
            if(window.innerWidth < 768) switchTab('preview');
        }

        function fillRemaining() {
            const mode = document.querySelector('input[name="practiceMode"]:checked').value;
            const cost = mode === 'progressive' ? 3 : (mode === 'plana' ? 2 : 1);
            const lines = els.input.value.split('\n').filter(x => x.trim() !== '');
            const usedSlots = lines.length;
            const maxSlots = Math.floor(maxLinesDynamic / cost);
            const remaining = maxSlots - usedSlots;
            if (remaining <= 0) { alert("Hoja llena."); return; }
            for(let i=0; i<remaining; i++) els.input.value += '\n{{OLAS}}';
            render();
        }

        function resetAll() { 
            els.input.value = ''; 
            els.youtubeContainer.classList.add('hidden');
            render(); 
        }
        function setColor(c) { selectedColor = c; render(); }
        function switchTab(t) {
            if(t==='config') { document.getElementById('panelConfig').classList.remove('hidden'); document.getElementById('panelPreview').classList.add('hidden'); document.getElementById('panelPreview').classList.remove('flex'); }
            else { document.getElementById('panelConfig').classList.add('hidden'); document.getElementById('panelPreview').classList.remove('hidden'); document.getElementById('panelPreview').classList.add('flex'); }
        }

        // Metr√≥nomo
        function toggleMetronome() {
            if(isMetronomeOn) {
                clearInterval(metronomeInterval);
                els.metroBtn.textContent = "‚ñ∂";
                isMetronomeOn = false;
            } else {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const bpm = parseInt(els.bpmInput.value) || 60;
                const intervalMs = 60000 / bpm;
                playClick();
                metronomeInterval = setInterval(playClick, intervalMs);
                els.metroBtn.textContent = "‚èπ";
                isMetronomeOn = true;
            }
        }

        function playClick() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = 1000;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function exportLesson() {
            const data = els.input.value;
            const blob = new Blob([data], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'leccion_caligrafia.txt';
            a.click();
        }

        function importLesson(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { els.input.value = e.target.result; render(); };
            reader.readAsText(file);
        }

        function saveState() {
            const state = {
                text: els.input.value, size: els.size.value, opacity: els.opacity.value,
                font: els.font.value, paper: els.paper.value, school: els.schoolInput.value,
                student: els.studentInput.value, mode: document.querySelector('input[name="practiceMode"]:checked').value,
                color: selectedColor, showHeader: els.checkHeader.checked, grayscale: els.checkGrayscale.checked, weight: els.weight.value
            };
            localStorage.setItem('caligrafiaState', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('caligrafiaState');
            if (saved) {
                const state = JSON.parse(saved);
                if(state.text) els.input.value = state.text;
                if(state.size) els.size.value = state.size;
                if(state.opacity) els.opacity.value = state.opacity;
                if(state.font) els.font.value = state.font;
                if(state.paper) els.paper.value = state.paper;
                if(state.school) els.schoolInput.value = state.school;
                if(state.student) els.studentInput.value = state.student;
                if(state.color) selectedColor = state.color;
                if(state.weight) els.weight.value = state.weight;
                if(state.mode) document.querySelector(`input[name="practiceMode"][value="${state.mode}"]`).checked = true;
                if(state.showHeader !== undefined) els.checkHeader.checked = state.showHeader;
                if(state.grayscale !== undefined) els.checkGrayscale.checked = state.grayscale;
            }
        }

        document.querySelectorAll('input, select, textarea').forEach(el => el.addEventListener('input', render));
        
        loadState();
        if(!els.input.value) fillPage('mix');
        if(window.innerWidth < 768) switchTab('preview');
        else { document.getElementById('panelConfig').classList.remove('hidden'); document.getElementById('panelPreview').classList.remove('hidden'); }
        render();
    </script>
</body>
</html>
